#!/bin/bash

# Pre-push hook that shows coverage status to agents
# Install with: cp scripts/git-hooks/pre-push .git/hooks/pre-push

echo "ü§ñ Agent Coverage Check"
echo "======================="

# Run quick coverage check
if command -v npm &> /dev/null; then
  # Get coverage status
  COVERAGE_OUTPUT=$(npm run coverage:agent:summary 2>/dev/null | tail -5)
  
  if [ $? -eq 0 ]; then
    # Parse results
    STATUS=$(echo "$COVERAGE_OUTPUT" | grep "COVERAGE_STATUS=" | cut -d'=' -f2)
    LINES=$(echo "$COVERAGE_OUTPUT" | grep "LINES_COVERAGE=" | cut -d'=' -f2)
    CRITICAL=$(echo "$COVERAGE_OUTPUT" | grep "CRITICAL_FILES=" | cut -d'=' -f2)
    ACTION=$(echo "$COVERAGE_OUTPUT" | grep "NEXT_ACTION=" | cut -d'=' -f2)
    
    # Show status
    if [ "$STATUS" = "COMPLIANT" ]; then
      echo "‚úÖ Coverage: ${LINES}% - ADR-0005 COMPLIANT"
    elif [ "$CRITICAL" -gt "0" ]; then
      echo "üî¥ Coverage: ${LINES}% - ${CRITICAL} CRITICAL FILES"
      echo "‚ö†Ô∏è  Action needed: $ACTION"
    else
      echo "üü° Coverage: ${LINES}% - NEEDS IMPROVEMENT"
      echo "üí° Next: $ACTION"
    fi
    
    echo ""
    echo "üìã Agent Commands:"
    echo "   npm run coverage:auto    # Auto-generate tests"
    echo "   npm run coverage:html    # Detailed analysis"
    echo ""
  else
    echo "‚ö†Ô∏è  Could not check coverage (run 'npm install' first)"
  fi
else
  echo "‚ö†Ô∏è  npm not found - skipping coverage check"
fi

# Always allow push (non-blocking)
exit 0