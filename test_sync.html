<!DOCTYPE html>
<html>
<head>
    <title>Sync Test</title>
    
    <!-- Module Preloads for Performance -->
    <!-- Core modules used by test sync -->
    <link rel="modulepreload" href="js/yjs.js">
    
    <!-- YJS dependencies from node_modules -->
    <link rel="modulepreload" href="./node_modules/yjs/dist/yjs.mjs">
    <link rel="modulepreload" href="./node_modules/y-websocket/src/y-websocket.js">
    <link rel="modulepreload" href="./node_modules/y-indexeddb/src/y-indexeddb.js">
    <link rel="modulepreload" href="./node_modules/y-protocols/sync.js">
    <link rel="modulepreload" href="./node_modules/y-protocols/awareness.js">
    <link rel="modulepreload" href="./node_modules/lib0/observable.js">
    <link rel="modulepreload" href="./node_modules/lib0/array.js">
    <link rel="modulepreload" href="./node_modules/lib0/map.js">
    <link rel="modulepreload" href="./node_modules/lib0/encoding.js">
    <link rel="modulepreload" href="./node_modules/lib0/decoding.js">
    <link rel="modulepreload" href="./node_modules/lib0/random.js">
    <link rel="modulepreload" href="./node_modules/lib0/environment.js">
    <link rel="modulepreload" href="./node_modules/lib0/indexeddb.js">
    <link rel="modulepreload" href="./node_modules/lib0/broadcastchannel.js">
</head>
<body>
    <h1>Sync Test</h1>
    <div id="output"></div>
    <button onclick="testSync()">Test Sync</button>
    <button onclick="setServer()">Set Server</button>
    
    <script type="module">
        let yjsSystem = null;
        
        function log(msg) {
            document.getElementById('output').innerHTML += '<p>' + msg + '</p>';
            console.log(msg);
        }
        
        async function initYjs() {
            try {
                const { createSystem } = await import('./js/yjs.js');
                yjsSystem = await createSystem();
                log('Yjs system initialized');
                return yjsSystem;
            } catch (e) {
                log('Error initializing Yjs: ' + e.message);
                return null;
            }
        }
        
        async function setServer() {
            if (!yjsSystem) {
                await initYjs();
            }
            
            try {
                yjsSystem.setSetting('sync-server-url', 'ws://192.168.1.104:1234');
                log('Set server to ws://192.168.1.104:1234 in Yjs settings');
            } catch (e) {
                log('Error setting sync server: ' + e.message);
            }
        }
        
        async function testSync() {
            log('Testing sync configuration...');
            
            if (!yjsSystem) {
                await initYjs();
            }
            
            // Check Yjs settings
            try {
                const saved = yjsSystem.getSetting('sync-server-url', '');
                log('Saved server in Yjs: ' + (saved || 'Not configured'));
            } catch (e) {
                log('Error getting sync server: ' + e.message);
            }
            
            // Test sync server from settings
            try {
                const syncServer = await getSetting('sync-server-url', '');
                log('Sync server from settings: ' + (syncServer || 'Not configured'));
            } catch (e) {
                log('Error getting sync server: ' + e.message);
            }
        }
        
        // Make functions global so buttons can call them
        window.setServer = setServer;
        window.testSync = testSync;
        
        // Initialize on load
        log('Page loaded - ready to test');
    </script>
</body>
</html>
